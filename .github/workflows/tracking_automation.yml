name: 3PL Tracking Automation

on:
  schedule:
    # ì›”~ê¸ˆìš”ì¼ KST 15:05 (ì˜¤í›„ 3ì‹œ 5ë¶„)ì— ì‹¤í–‰
    # UTC ê¸°ì¤€: KSTëŠ” UTC+9ì´ë¯€ë¡œ 06:05
    - cron: '5 6 * * 1-5'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  tracking_processing:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir numpy==1.24.3
        pip install --no-cache-dir -r requirements.txt
        
    - name: Set timezone to KST
      run: |
        sudo timedatectl set-timezone Asia/Seoul
        
    - name: Run tracking updater
      env:
        # ë¯¸ë‹ˆí•™ìŠµì§€ í™˜ê²½ë³€ìˆ˜
        WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
        WP_WOO_CONSUMER_KEY: ${{ secrets.WP_WOO_CONSUMER_KEY }}
        WP_WOO_CONSUMER_SECRET: ${{ secrets.WP_WOO_CONSUMER_SECRET }}
        
        # ë…ë…ë… í™˜ê²½ë³€ìˆ˜
        DOK_WP_BASE_URL: ${{ secrets.DOK_WP_BASE_URL }}
        DOK_WP_WOO_CONSUMER_KEY: ${{ secrets.DOK_WP_WOO_CONSUMER_KEY }}
        DOK_WP_WOO_CONSUMER_SECRET: ${{ secrets.DOK_WP_WOO_CONSUMER_SECRET }}
        
        # Google Service Account (ê°œë³„ í•„ë“œ)
        GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
        GOOGLE_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_PRIVATE_KEY_ID }}
        GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_AUTH_URI: ${{ secrets.GOOGLE_AUTH_URI }}
        GOOGLE_TOKEN_URI: ${{ secrets.GOOGLE_TOKEN_URI }}
        GOOGLE_AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.GOOGLE_AUTH_PROVIDER_X509_CERT_URL }}
        GOOGLE_CLIENT_X509_CERT_URL: ${{ secrets.GOOGLE_CLIENT_X509_CERT_URL }}
        GOOGLE_SHARED_DRIVE_ID: ${{ secrets.GOOGLE_SHARED_DRIVE_ID }}
        GOOGLE_FOLDER_ID: ${{ secrets.GOOGLE_FOLDER_ID }}
        
        # ì´ë©”ì¼ ì„¤ì • (ê²°ê³¼ ë³´ê³ ìš©)
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        LOGIS_EMAIL_RECIPIENT: ${{ secrets.LOGIS_EMAIL_RECIPIENT }}
        
      run: |
        echo "ğŸ“¦ 3PL Tracking Updater ì‹œì‘ - $(date '+%Y-%m-%d %H:%M:%S KST')"
        python tracking_updater.py
        
    - name: Upload logs only
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tracking-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 3
